<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique de D√©mo</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; }
        #chat-bubble { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background-color: #007bff; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        #chat-widget { display: none; position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); flex-direction: column; }
        .chat-header { background-color: #007bff; color: white; padding: 15px; font-weight: bold; text-align: center; border-radius: 15px 15px 0 0; }
        .chat-body { flex-grow: 1; padding: 10px; overflow-y: auto; }
        .chat-footer { padding: 10px; display: flex; border-top: 1px solid #ddd; }
        #chat-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px; }
        #send-btn { background: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 10px; cursor: pointer; }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 18px; max-width: 80%; line-height: 1.4; }
        .user-message { background-color: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .bot-message { background-color: #e9e9eb; color: black; align-self: flex-start; }
        .chat-body-inner { display: flex; flex-direction: column; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bienvenue sur notre Boutique !</h1>
        <p>Cliquez sur la bulle pour parler √† notre assistant IA.</p>
    </div>

    <div id="chat-bubble">üí¨</div>
    <div id="chat-widget">
        <div class="chat-header">Assistant Virtuel</div>
        <div class="chat-body"><div class="chat-body-inner">
            <div class="message bot-message">Bonjour ! Comment puis-je vous aider ?</div>
        </div></div>
        <div class="chat-footer">
            <input type="text" id="chat-input" placeholder="Tapez votre message..."><button id="send-btn">‚û§</button>
        </div>
    </div>

    <script>
        const chatBubble = document.getElementById('chat-bubble');
        const chatWidget = document.getElementById('chat-widget');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatBody = document.querySelector('.chat-body-inner');
        
        // On utilise sessionStorage pour que l'ID soit unique √† chaque onglet.
        // C'est plus robuste pour les tests.
        let sessionId = sessionStorage.getItem('chat_session_id');

        chatBubble.addEventListener('click', () => {
            chatWidget.style.display = chatWidget.style.display === 'none' ? 'flex' : 'none';
        });

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());

        function addMessage(text, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
            msgDiv.textContent = text;
            chatBody.appendChild(msgDiv);
            chatBody.parentElement.scrollTop = chatBody.parentElement.scrollHeight;
        }

        async function sendMessage() {
            const userText = chatInput.value.trim();
            if (userText === '') return;
            addMessage(userText, 'user');
            chatInput.value = '';

            // On pr√©pare le corps de la requ√™te
            const requestBody = {
                texte: userText
            };
            // On n'ajoute l'id_session que s'il existe d√©j√† !
            if (sessionId) {
                requestBody.id_session = sessionId;
            }

            try {
                const response = await fetch('http://127.0.0.1:8000/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                
                const data = await response.json();
                
                // On met √† jour l'ID de session avec celui renvoy√© par le serveur
                // C'est la ligne la plus importante pour maintenir la conversation
                sessionId = data.id_session;
                sessionStorage.setItem('chat_session_id', sessionId);
                
                addMessage(data.texte, 'bot');
            } catch (error) {
                console.error('Erreur API:', error);
                addMessage('D√©sol√©, une erreur de connexion est survenue.', 'bot');
            }
        }
    </script>
</body>
</html>